###############################################################################
#                                                                             #
# IAR C/C++ Compiler V8.10.3.10338/W32 for 8051         11/Jul/2018  20:53:01 #
# Copyright 2004-2011 IAR Systems AB.                                         #
#                                                                             #
#    Core               =  plain                                              #
#    Code model         =  banked                                             #
#    Data model         =  large                                              #
#    Calling convention =  xdata reentrant                                    #
#    Constant location  =  data_rom                                           #
#    Dptr setup         =  1,16                                               #
#    Source file        =  D:\hardware\logger\logger\Projects\zstack\Samples\ #
#                          GenericApp\Source\simI2C.c                         #
#    Command line       =  -f D:\hardware\logger\logger\Projects\zstack\Sampl #
#                          es\GenericApp\CC2530DB\..\..\..\Tools\CC2530DB\f8w #
#                          Router.cfg (-DCPU32MHZ -DROOT=__near_func          #
#                          -DMAC_CFG_APP_PENDING_QUEUE=TRUE                   #
#                          -DMAC_CFG_TX_DATA_MAX=5 -DMAC_CFG_TX_MAX=8         #
#                          -DMAC_CFG_RX_MAX=5 -DRTR_NWK) -f                   #
#                          D:\hardware\logger\logger\Projects\zstack\Samples\ #
#                          GenericApp\CC2530DB\..\..\..\Tools\CC2530DB\f8wCon #
#                          fig.cfg (-DZIGBEEPRO -DSECURE=0                    #
#                          -DZG_SECURE_DYNAMIC=0 -DREFLECTOR                  #
#                          -DDEFAULT_CHANLIST=0x00000800                      #
#                          -DZDAPP_CONFIG_PAN_ID=0xFFFF                       #
#                          -DNWK_START_DELAY=100 -DEXTENDED_JOINING_RANDOM_MA #
#                          SK=0x007F -DBEACON_REQUEST_DELAY=100               #
#                          -DBEACON_REQ_DELAY_MASK=0x00FF                     #
#                          -DLINK_STATUS_JITTER_MASK=0x007F                   #
#                          -DROUTE_EXPIRY_TIME=30 -DAPSC_ACK_WAIT_DURATION_PO #
#                          LLED=3000 -DNWK_INDIRECT_MSG_TIMEOUT=7             #
#                          -DMAX_RREQ_ENTRIES=8 -DAPSC_MAX_FRAME_RETRIES=3    #
#                          -DNWK_MAX_DATA_RETRIES=2                           #
#                          -DMAX_POLL_FAILURE_RETRIES=2 -DMAX_BCAST=9         #
#                          -DAPS_MAX_GROUPS=16 -DMAX_RTG_ENTRIES=40           #
#                          -DNWK_MAX_BINDING_ENTRIES=4                        #
#                          -DMAX_BINDING_CLUSTER_IDS=4 "-DDEFAULT_KEY={0x01,  #
#                          0x03, 0x05, 0x07, 0x09, 0x0B, 0x0D, 0x0F, 0x00,    #
#                          0x02, 0x04, 0x06, 0x08, 0x0A, 0x0C, 0x0D}"         #
#                          -DMAC_MAX_FRAME_SIZE=116                           #
#                          -DZDNWKMGR_MIN_TRANSMISSIONS=20 "-DCONST=const     #
#                          __code" -DGENERIC=__generic                        #
#                          -DRFD_RCVC_ALWAYS_ON=FALSE -DPOLL_RATE=1000        #
#                          -DQUEUED_POLL_RATE=100 -DRESPONSE_POLL_RATE=100)   #
#                          -DREJOIN_POLL_RATE=440 D:\hardware\logger\logger\P #
#                          rojects\zstack\Samples\GenericApp\Source\simI2C.c  #
#                          -D ZTOOL_P1 -D MT_TASK -D MT_SYS_FUNC -D           #
#                          MT_ZDO_FUNC -D LCD_SUPPORTED=DEBUG -lC             #
#                          D:\hardware\logger\logger\Projects\zstack\Samples\ #
#                          GenericApp\CC2530DB\RouterEB\List\ -lA             #
#                          D:\hardware\logger\logger\Projects\zstack\Samples\ #
#                          GenericApp\CC2530DB\RouterEB\List\                 #
#                          --diag_suppress Pe001,Pa010 -o                     #
#                          D:\hardware\logger\logger\Projects\zstack\Samples\ #
#                          GenericApp\CC2530DB\RouterEB\Obj\ -e               #
#                          --no_code_motion --debug --core=plain --dptr=16,1  #
#                          --data_model=large --code_model=banked             #
#                          --calling_convention=xdata_reentrant               #
#                          --place_constants=data_rom --nr_virtual_regs 16    #
#                          -I D:\hardware\logger\logger\Projects\zstack\Sampl #
#                          es\GenericApp\CC2530DB\ -I                         #
#                          D:\hardware\logger\logger\Projects\zstack\Samples\ #
#                          GenericApp\CC2530DB\..\Source\ -I                  #
#                          D:\hardware\logger\logger\Projects\zstack\Samples\ #
#                          GenericApp\CC2530DB\..\..\..\ZMain\TI2530DB\ -I    #
#                          D:\hardware\logger\logger\Projects\zstack\Samples\ #
#                          GenericApp\CC2530DB\..\..\..\..\..\Components\hal\ #
#                          include\ -I D:\hardware\logger\logger\Projects\zst #
#                          ack\Samples\GenericApp\CC2530DB\..\..\..\..\..\Com #
#                          ponents\hal\target\CC2530EB\ -I                    #
#                          D:\hardware\logger\logger\Projects\zstack\Samples\ #
#                          GenericApp\CC2530DB\..\..\..\..\..\Components\mac\ #
#                          include\ -I D:\hardware\logger\logger\Projects\zst #
#                          ack\Samples\GenericApp\CC2530DB\..\..\..\..\..\Com #
#                          ponents\mac\high_level\ -I                         #
#                          D:\hardware\logger\logger\Projects\zstack\Samples\ #
#                          GenericApp\CC2530DB\..\..\..\..\..\Components\mac\ #
#                          low_level\srf04\ -I D:\hardware\logger\logger\Proj #
#                          ects\zstack\Samples\GenericApp\CC2530DB\..\..\..\. #
#                          .\..\Components\mac\low_level\srf04\single_chip\   #
#                          -I D:\hardware\logger\logger\Projects\zstack\Sampl #
#                          es\GenericApp\CC2530DB\..\..\..\..\..\Components\m #
#                          t\ -I D:\hardware\logger\logger\Projects\zstack\Sa #
#                          mples\GenericApp\CC2530DB\..\..\..\..\..\Component #
#                          s\osal\include\ -I D:\hardware\logger\logger\Proje #
#                          cts\zstack\Samples\GenericApp\CC2530DB\..\..\..\.. #
#                          \..\Components\services\saddr\ -I                  #
#                          D:\hardware\logger\logger\Projects\zstack\Samples\ #
#                          GenericApp\CC2530DB\..\..\..\..\..\Components\serv #
#                          ices\sdata\ -I D:\hardware\logger\logger\Projects\ #
#                          zstack\Samples\GenericApp\CC2530DB\..\..\..\..\..\ #
#                          Components\stack\af\ -I D:\hardware\logger\logger\ #
#                          Projects\zstack\Samples\GenericApp\CC2530DB\..\..\ #
#                          ..\..\..\Components\stack\nwk\ -I                  #
#                          D:\hardware\logger\logger\Projects\zstack\Samples\ #
#                          GenericApp\CC2530DB\..\..\..\..\..\Components\stac #
#                          k\sapi\ -I D:\hardware\logger\logger\Projects\zsta #
#                          ck\Samples\GenericApp\CC2530DB\..\..\..\..\..\Comp #
#                          onents\stack\sec\ -I D:\hardware\logger\logger\Pro #
#                          jects\zstack\Samples\GenericApp\CC2530DB\..\..\..\ #
#                          ..\..\Components\stack\sys\ -I                     #
#                          D:\hardware\logger\logger\Projects\zstack\Samples\ #
#                          GenericApp\CC2530DB\..\..\..\..\..\Components\stac #
#                          k\zdo\ -I D:\hardware\logger\logger\Projects\zstac #
#                          k\Samples\GenericApp\CC2530DB\..\..\..\..\..\Compo #
#                          nents\zmac\ -I D:\hardware\logger\logger\Projects\ #
#                          zstack\Samples\GenericApp\CC2530DB\..\..\..\..\..\ #
#                          Components\zmac\f8w\ -Ohz --require_prototypes     #
#    List file          =  D:\hardware\logger\logger\Projects\zstack\Samples\ #
#                          GenericApp\CC2530DB\RouterEB\List\simI2C.lst       #
#    Object file        =  D:\hardware\logger\logger\Projects\zstack\Samples\ #
#                          GenericApp\CC2530DB\RouterEB\Obj\simI2C.r51        #
#                                                                             #
#                                                                             #
###############################################################################

D:\hardware\logger\logger\Projects\zstack\Samples\GenericApp\Source\simI2C.c
      1          /* Library includes. */
      2          #include <ioCC2530.h>

   \                                 In  segment SFR_AN, at 0x90
   \   union <unnamed> volatile __sfr _A_P1
   \                     _A_P1:
   \   000000                DS 1

   \                                 In  segment SFR_AN, at 0xf4
   \   unsigned char volatile __sfr P1SEL
   \                     P1SEL:
   \   000000                DS 1

   \                                 In  segment SFR_AN, at 0xf6
   \   unsigned char volatile __sfr P1INP
   \                     P1INP:
   \   000000                DS 1

   \                                 In  segment SFR_AN, at 0xfe
   \   unsigned char volatile __sfr P1DIR
   \                     P1DIR:
   \   000000                DS 1
      3          #include "OnBoard.h"
      4          #include "simI2C.h"
      5          
      6          #define DELAY_TIME_IC 0x0010
      7          #define DELAY2 0x001
      8          
      9          

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
     10          void udelay(uint Time)
   \                     udelay:
     11          {
   \   000000   74F7         MOV     A,#-0x9
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 9
   \   000005                ; Auto size: 0
   \   000005   EA           MOV     A,R2
   \   000006   FE           MOV     R6,A
   \   000007   EB           MOV     A,R3
   \   000008   FF           MOV     R7,A
     12            int i;
     13            while(Time--)
   \                     ??udelay_0:
   \   000009   EE           MOV     A,R6
   \   00000A   F8           MOV     R0,A
   \   00000B   EF           MOV     A,R7
   \   00000C   F9           MOV     R1,A
   \   00000D   E8           MOV     A,R0
   \   00000E   24FF         ADD     A,#-0x1
   \   000010   1E           DEC     R6
   \   000011   E9           MOV     A,R1
   \   000012   34FF         ADDC    A,#-0x1
   \   000014   FF           MOV     R7,A
   \   000015   E8           MOV     A,R0
   \   000016   49           ORL     A,R1
   \   000017   6012         JZ      ??udelay_1
     14            {
     15              for(i=0;i<100;i++)
   \   000019   75..64       MOV     ?V0 + 0,#0x64
     16                  MicroWait(10);
   \                     ??udelay_2:
   \   00001C                ; Setup parameters for call to function Onboard_wait
   \   00001C   7A0A         MOV     R2,#0xa
   \   00001E   7B00         MOV     R3,#0x0
   \   000020   12....       LCALL   ??Onboard_wait?relay
   \   000023   15..         DEC     ?V0 + 0
   \   000025   E5..         MOV     A,?V0 + 0
   \   000027   60E0         JZ      ??udelay_0
   \   000029   80F1         SJMP    ??udelay_2
     17            }
     18          }
   \                     ??udelay_1:
   \   00002B                REQUIRE ?Subroutine0
   \   00002B                ; // Fall through to label ?Subroutine0

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine0:
   \   000000   7F01         MOV     R7,#0x1
   \   000002   02....       LJMP    ?BANKED_LEAVE_XDATA
     19          
     20          
     21          
     22          
     23          #if 0
     24          void set_gpio_direction(uint16_t pin, unsigned char mode)
     25          {
     26          	GPIO_InitTypeDef GPIO_InitStructure;	
     27          
     28          	GPIO_InitStructure.GPIO_Pin = pin;
     29          	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
     30          	GPIO_InitStructure.GPIO_Mode = mode;
     31          	GPIO_Init(IPORT, &GPIO_InitStructure);	
     32          }
     33          
     34          
     35          unsigned char get_gpio_value(uint16_t pin){
     36          
     37          	return GPIO_ReadInputDataBit(IPORT,pin);
     38          }
     39          
     40          
     41          void simI2c_master_init(void)
     42          {
     43          	GPIO_DeInit(IPORT);
     44          	RCC_APB2PeriphClockCmd( RCC_PORT , ENABLE); 	
     45          	set_gpio_direction(SDA | SCL,OUTP);
     46          
     47          }
     48          
     49          #endif
     50          
     51          // if the pin define is changed,the following function must be changed

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
     52          void set_scl_output(void)
   \                     set_scl_output:
     53          {
   \   000000                ; Saved register size: 0
   \   000000                ; Auto size: 0
     54             P1SEL &= 0xFE;  //p1.0 
   \   000000   53F4FE       ANL     0xf4,#0xfe
     55             P1DIR |= 0x01;
   \   000003   43FE01       ORL     0xfe,#0x1
     56          }
   \   000006   02....       LJMP    ?BRET
   \   000009                REQUIRE P1SEL
   \   000009                REQUIRE P1DIR
     57          

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
     58          void set_sda_output(void)
   \                     set_sda_output:
     59          {
   \   000000                ; Saved register size: 0
   \   000000                ; Auto size: 0
     60             P1SEL &= 0xFD;  //p1.1
   \   000000   53F4FD       ANL     0xf4,#0xfd
     61             P1DIR |= 0x02;
   \   000003   43FE02       ORL     0xfe,#0x2
     62          }
   \   000006   02....       LJMP    ?BRET
   \   000009                REQUIRE P1SEL
   \   000009                REQUIRE P1DIR
     63          

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
     64          void set_scl_input(void)
   \                     set_scl_input:
     65          {
   \   000000                ; Saved register size: 0
   \   000000                ; Auto size: 0
     66          
     67              P1SEL &= ~0x01;     //设置P1.0为普通IO口  
   \   000000   53F4FE       ANL     0xf4,#0xfe
     68              P1DIR &= ~0x01;     //设P1.0为输入模式 
   \   000003   53FEFE       ANL     0xfe,#0xfe
     69              P1INP &= ~0x01;     //打开P1.0上拉电阻 ???
   \   000006   53F6FE       ANL     0xf6,#0xfe
     70          }
   \   000009   02....       LJMP    ?BRET
   \   00000C                REQUIRE P1SEL
   \   00000C                REQUIRE P1DIR
   \   00000C                REQUIRE P1INP
     71          

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
     72          void set_sda_input(void)
   \                     set_sda_input:
     73          {
   \   000000                ; Saved register size: 0
   \   000000                ; Auto size: 0
     74          
     75              P1SEL &= ~0x02;     //设置P1.1为普通IO口  
   \   000000   53F4FD       ANL     0xf4,#0xfd
     76              P1DIR &= ~0x02;     //设P1.1为输入模式 
   \   000003   53FEFD       ANL     0xfe,#0xfd
     77              P1INP &= ~0x02;     //打开P1.1上拉电阻 ???
   \   000006   53F6FD       ANL     0xf6,#0xfd
     78          }
   \   000009   02....       LJMP    ?BRET
   \   00000C                REQUIRE P1SEL
   \   00000C                REQUIRE P1DIR
   \   00000C                REQUIRE P1INP
     79          
     80          
     81          /* I2C起始条件 */  

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
     82          int simI2c_start(void)  
   \                     simI2c_start:
     83          {
   \   000000   C082         PUSH    DPL
   \   000002   C083         PUSH    DPH
   \   000004                ; Saved register size: 2
   \   000004                ; Auto size: 0
     84          
     85              set_scl_output();
   \   000004                ; Setup parameters for call to function set_scl_output
   \   000004   12....       LCALL   ??set_scl_output?relay
     86              set_sda_output();
   \   000007                ; Setup parameters for call to function set_sda_output
   \   000007   12....       LCALL   ??set_sda_output?relay
     87          	
     88          
     89              SDA_HIGH;             //设置SDA为高电平  
   \   00000A   D291         SETB    0x90.1
     90              SCL_HIGH;             //设置SCL为高电平  
   \   00000C   D290         SETB    0x90.0
     91              udelay(DELAY_TIME_IC);          //延时  
   \   00000E                ; Setup parameters for call to function udelay
   \   00000E   7A10         MOV     R2,#0x10
   \   000010   7B00         MOV     R3,#0x0
   \   000012   12....       LCALL   ??udelay?relay
     92                  		 //起始条件  
     93              SDA_LOW;            //SCL为高电平时，SDA由高变低  
   \   000015   C291         CLR     0x90.1
     94              udelay(DELAY_TIME_IC); 
   \   000017                ; Setup parameters for call to function udelay
   \   000017   7A10         MOV     R2,#0x10
   \   000019   7B00         MOV     R3,#0x0
   \   00001B   12....       LCALL   ??udelay?relay
     95          
     96              return 1;
   \   00001E   7A01         MOV     R2,#0x1
   \   000020   7B00         MOV     R3,#0x0
   \   000022   80..         SJMP    ?Subroutine1
   \   000024                REQUIRE _A_P1
     97          } 

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine1:
   \   000000   D083         POP     DPH
   \   000002   D082         POP     DPL
   \   000004   02....       LJMP    ?BRET
     98          
     99          
    100          
    101          
    102          
    103          /* I2C终止条件 */  

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    104          void simI2c_stop(void)  
   \                     simI2c_stop:
    105          {  
   \   000000   C082         PUSH    DPL
   \   000002   C083         PUSH    DPH
   \   000004                ; Saved register size: 2
   \   000004                ; Auto size: 0
    106              set_sda_output(); 
   \   000004                ; Setup parameters for call to function set_sda_output
   \   000004   12....       LCALL   ??set_sda_output?relay
    107          
    108            //SCL高电平时，SDA由低变高  
    109              SCL_HIGH;
   \   000007   D290         SETB    0x90.0
    110              SDA_LOW;
   \   000009   C291         CLR     0x90.1
    111              udelay(DELAY_TIME_IC); 
   \   00000B                ; Setup parameters for call to function udelay
   \   00000B   7A10         MOV     R2,#0x10
   \   00000D   7B00         MOV     R3,#0x0
   \   00000F   12....       LCALL   ??udelay?relay
    112              SDA_HIGH;     
   \   000012   D291         SETB    0x90.1
    113          }
   \   000014   80..         SJMP    ?Subroutine1
   \   000016                REQUIRE _A_P1
    114          
    115          
    116          
    117            
    118          /*   
    119          I2C读取ACK信号(写数据时使用)  
    120          返回值 ：0表示ACK信号有效；非0表示ACK信号无效  
    121          */  

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    122          uint8 simI2c_read_ack(void)  
   \                     simI2c_read_ack:
    123          {  
   \   000000   C082         PUSH    DPL
   \   000002   C083         PUSH    DPH
   \   000004                ; Saved register size: 2
   \   000004                ; Auto size: 0
    124              uint8 r =0;  
    125              set_sda_input();        //设置SDA方向为输入  
   \   000004                ; Setup parameters for call to function set_sda_input
   \   000004   12....       LCALL   ??set_sda_input?relay
    126          
    127              SCL_HIGH;    // SCL变高  
   \   000007   D290         SETB    0x90.0
    128              udelay(DELAY_TIME_IC);  
   \   000009                ; Setup parameters for call to function udelay
   \   000009   7A10         MOV     R2,#0x10
   \   00000B   7B00         MOV     R3,#0x0
   \   00000D   12....       LCALL   ??udelay?relay
    129              r = SDA;            //读取ACK信号  
   \   000010   E590         MOV     A,0x90
    130              SCL_LOW;		
   \   000012   C290         CLR     0x90.0
    131          
    132              return r;  
   \   000014   A2E1         MOV     C,0xE0 /* A   */.1
   \   000016   E4           CLR     A
   \   000017   33           RLC     A
   \   000018   F9           MOV     R1,A
   \   000019                REQUIRE ?Subroutine1
   \   000019                REQUIRE _A_P1
   \   000019                ; // Fall through to label ?Subroutine1
    133          } 
    134          
    135          
    136          /* I2C发出ACK信号(读数据时使用) */  

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    137          void simI2c_send_ack(void)  
   \                     simI2c_send_ack:
    138          {  
   \   000000   C082         PUSH    DPL
   \   000002   C083         PUSH    DPH
   \   000004                ; Saved register size: 2
   \   000004                ; Auto size: 0
    139              set_sda_output(); 
   \   000004                ; Setup parameters for call to function set_sda_output
   \   000004   12....       LCALL   ??set_sda_output?relay
    140          
    141              SCL_LOW;                                // SCL变低  
   \   000007   C290         CLR     0x90.0
    142              SDA_LOW;                                //发出ACK信号  
   \   000009   C291         CLR     0x90.1
    143              udelay(DELAY_TIME_IC);  
   \   00000B                ; Setup parameters for call to function udelay
   \   00000B   7A10         MOV     R2,#0x10
   \   00000D   12....       LCALL   ?Subroutine3 & 0xFFFF
    144              SCL_HIGH;             // SCL变高  
    145              udelay(DELAY_TIME_IC);  
    146          } 
   \                     ??CrossCallReturnLabel_0:
   \   000010   80..         SJMP    ?Subroutine1
   \   000012                REQUIRE _A_P1

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine3:
   \   000000   7B00         MOV     R3,#0x0
   \   000002   12....       LCALL   ??udelay?relay
   \   000005   D290         SETB    0x90.0
   \   000007                ; Setup parameters for call to function udelay
   \   000007                ; Setup parameters for call to function udelay
   \   000007   7A10         MOV     R2,#0x10
   \   000009   7B00         MOV     R3,#0x0
   \   00000B   12....       LCALL   ??udelay?relay
   \   00000E   22           RET
    147          
    148          
    149          /* I2C字节写 */  

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    150          void simI2c_write_byte(unsigned char b)  
   \                     simI2c_write_byte:
    151          {  
   \   000000   74F4         MOV     A,#-0xc
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 12
   \   000005                ; Auto size: 0
   \   000005   89..         MOV     ?V0 + 0,R1
    152              int i; 
    153              uint8 r = 0;  
    154              set_sda_output(); 
   \   000007                ; Setup parameters for call to function set_sda_output
   \   000007   12....       LCALL   ??set_sda_output?relay
    155            
    156              for (i=7; i>=0; i--) 
   \   00000A   7E07         MOV     R6,#0x7
   \   00000C   7F00         MOV     R7,#0x0
    157              {  
    158                      SCL_LOW;             // SCL变低  
   \                     ??simI2c_write_byte_0:
   \   00000E   C290         CLR     0x90.0
    159                      udelay(DELAY_TIME_IC);  
   \   000010                ; Setup parameters for call to function udelay
   \   000010   7A10         MOV     R2,#0x10
   \   000012   7B00         MOV     R3,#0x0
   \   000014   12....       LCALL   ??udelay?relay
    160            
    161                      //从高位到低位依次准备数据进行发送  
    162                      if(b & (1<<i))
   \   000017   75..01       MOV     ?V0 + 2,#0x1
   \   00001A   75..00       MOV     ?V0 + 3,#0x0
   \   00001D   EE           MOV     A,R6
   \   00001E   78..         MOV     R0,#?V0 + 2
   \   000020   12....       LCALL   ?S_SHL
   \   000023   E5..         MOV     A,?V0 + 2
   \   000025   55..         ANL     A,?V0 + 0
   \   000027   6004         JZ      ??simI2c_write_byte_1
    163                              SDA_HIGH;
   \   000029   D291         SETB    0x90.1
   \   00002B   8002         SJMP    ??simI2c_write_byte_2
    164                      else
    165                              SDA_LOW;
   \                     ??simI2c_write_byte_1:
   \   00002D   C291         CLR     0x90.1
    166                      
    167                      udelay(DELAY2);  // guojun
   \                     ??simI2c_write_byte_2:
   \   00002F                ; Setup parameters for call to function udelay
   \   00002F   7A01         MOV     R2,#0x1
   \   000031   12....       LCALL   ?Subroutine3 & 0xFFFF
    168            
    169                      SCL_HIGH;
    170            
    171                      udelay(DELAY_TIME_IC);  
    172              }  
   \                     ??CrossCallReturnLabel_1:
   \   000034   EE           MOV     A,R6
   \   000035   24FF         ADD     A,#-0x1
   \   000037   1E           DEC     R6
   \   000038   EF           MOV     A,R7
   \   000039   34FF         ADDC    A,#-0x1
   \   00003B   FF           MOV     R7,A
   \   00003C   C3           CLR     C
   \   00003D   9400         SUBB    A,#0x0
   \   00003F   A2D2         MOV     C,0xD0 /* PSW */.2
   \   000041   65D0         XRL     A,PSW
   \   000043   33           RLC     A
   \   000044   50C8         JNC     ??simI2c_write_byte_0
    173              SCL_LOW;
   \   000046   C290         CLR     0x90.0
    174              SDA_HIGH; 
   \   000048   D291         SETB    0x90.1
    175                      
    176              udelay(DELAY_TIME_IC); 	
   \   00004A                ; Setup parameters for call to function udelay
   \   00004A   7A10         MOV     R2,#0x10
   \   00004C   7B00         MOV     R3,#0x0
   \   00004E   12....       LCALL   ??udelay?relay
    177              
    178              r = simI2c_read_ack();				   //检查目标设备的ACK信号  
    179              //0:ACK 1:NCK 
    180              if(r)
   \   000051                ; Setup parameters for call to function simI2c_read_ack
   \   000051   12....       LCALL   ??simI2c_read_ack?relay
   \   000054   E9           MOV     A,R1
   \   000055   600D         JZ      ??simI2c_write_byte_3
    181              {
    182                    HalUARTWrite(0,"nak?!?",4);   
   \   000057                ; Setup parameters for call to function HalUARTWrite
   \   000057   7C04         MOV     R4,#0x4
   \   000059   7D00         MOV     R5,#0x0
   \   00005B   7A..         MOV     R2,#`?<Constant "nak?!?">` & 0xff
   \   00005D   7B..         MOV     R3,#(`?<Constant "nak?!?">` >> 8) & 0xff
   \   00005F   7900         MOV     R1,#0x0
   \   000061   12....       LCALL   ??HalUARTWrite?relay
    183              }
    184          } 
   \                     ??simI2c_write_byte_3:
   \   000064   7F04         MOV     R7,#0x4
   \   000066   02....       LJMP    ?BANKED_LEAVE_XDATA
   \   000069                REQUIRE _A_P1
    185          
    186          
    187          /* I2C字节读 */  

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    188          uint8 simI2c_read_byte(void)  
   \                     simI2c_read_byte:
    189          {  
   \   000000   74F7         MOV     A,#-0x9
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 9
   \   000005                ; Auto size: 0
    190              int i;  
    191              uint8 r = 0; 
   \   000005   7E00         MOV     R6,#0x0
    192              
    193              set_sda_input(); 
   \   000007                ; Setup parameters for call to function set_sda_input
   \   000007   12....       LCALL   ??set_sda_input?relay
    194              for (i=7; i>=0; i--) 
   \   00000A   7F08         MOV     R7,#0x8
    195              {
    196                  SCL_LOW;         // SCL变低  
   \                     ??simI2c_read_byte_0:
   \   00000C   C290         CLR     0x90.0
    197                  udelay(DELAY_TIME_IC);  
   \   00000E                ; Setup parameters for call to function udelay
   \   00000E   7A10         MOV     R2,#0x10
   \   000010   7B00         MOV     R3,#0x0
   \   000012   12....       LCALL   ??udelay?relay
    198                  r = (r <<1) | SDA;      //从高位到低位依次准备数据进行读取  
   \   000015   A291         MOV     C,0x90.1
   \   000017   E4           CLR     A
   \   000018   33           RLC     A
   \   000019   F8           MOV     R0,A
   \   00001A   EE           MOV     A,R6
   \   00001B   33           RLC     A
   \   00001C   48           ORL     A,R0
   \   00001D   FE           MOV     R6,A
    199                  SCL_HIGH;         // SCL变高  
   \   00001E   D290         SETB    0x90.0
    200                  udelay(DELAY_TIME_IC);  
   \   000020                ; Setup parameters for call to function udelay
   \   000020   7A10         MOV     R2,#0x10
   \   000022   7B00         MOV     R3,#0x0
   \   000024   12....       LCALL   ??udelay?relay
    201              }  
   \   000027   1F           DEC     R7
   \   000028   EF           MOV     A,R7
   \   000029   70E1         JNZ     ??simI2c_read_byte_0
    202              simI2c_send_ack();                 //向目标设备发送ACK信号  
   \   00002B                ; Setup parameters for call to function simI2c_send_ack
   \   00002B   12....       LCALL   ??simI2c_send_ack?relay
    203              return r;  
   \   00002E   EE           MOV     A,R6
   \   00002F   F9           MOV     R1,A
   \   000030   02....       LJMP    ?Subroutine0 & 0xFFFF
   \   000033                REQUIRE _A_P1
    204          } 
    205          
    206          
    207          /*  
    208          I2C读操作  
    209          addr：目标设备地址  
    210          buf：读缓冲区  
    211          len：读入字节的长度  
    212          */  

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    213          void simI2c_read(unsigned char addr, unsigned char* buf, int len)  
   \                     simI2c_read:
    214          {  
   \   000000   74F3         MOV     A,#-0xd
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 13
   \   000005                ; Auto size: 0
   \   000005   89..         MOV     ?V0 + 4,R1
   \   000007   EA           MOV     A,R2
   \   000008   FE           MOV     R6,A
   \   000009   EB           MOV     A,R3
   \   00000A   FF           MOV     R7,A
   \   00000B   8C..         MOV     ?V0 + 0,R4
   \   00000D   8D..         MOV     ?V0 + 1,R5
    215          	int i;  
    216          	uint8 t;  
    217          	simI2c_start();                        //起始条件，开始数据通信  
   \   00000F                ; Setup parameters for call to function simI2c_start
   \   00000F   12....       LCALL   ??simI2c_start?relay
    218          	
    219          	//发送地址和数据读写方向  
    220          	t = (addr << 1) | 1;                    //低位为1，表示读数据  
    221          	simI2c_write_byte(t);  
   \   000012                ; Setup parameters for call to function simI2c_write_byte
   \   000012   E5..         MOV     A,?V0 + 4
   \   000014   C3           CLR     C
   \   000015   33           RLC     A
   \   000016   4401         ORL     A,#0x1
   \   000018   12....       LCALL   ?Subroutine6 & 0xFFFF
    222          
    223          	//读入数据  
    224          	for (i=0; i<len; i++)  
   \                     ??CrossCallReturnLabel_6:
   \   00001B   800B         SJMP    ??CrossCallReturnLabel_4
    225          	buf[i] = simI2c_read_byte();  
   \                     ??simI2c_read_0:
   \   00001D                ; Setup parameters for call to function simI2c_read_byte
   \   00001D   12....       LCALL   ??simI2c_read_byte?relay
   \   000020   12....       LCALL   ?Subroutine7 & 0xFFFF
   \                     ??CrossCallReturnLabel_8:
   \   000023   E9           MOV     A,R1
   \   000024   F0           MOVX    @DPTR,A
   \   000025   12....       LCALL   ?Subroutine5 & 0xFFFF
   \                     ??CrossCallReturnLabel_4:
   \   000028   12....       LCALL   ?Subroutine4 & 0xFFFF
   \                     ??CrossCallReturnLabel_2:
   \   00002B   40F0         JC      ??simI2c_read_0
    226          	simI2c_stop();                     //终止条件，结束数据通信  
   \   00002D                ; Setup parameters for call to function simI2c_stop
   \   00002D                REQUIRE ?Subroutine2
   \   00002D                ; // Fall through to label ?Subroutine2
    227          }

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine2:
   \   000000   12....       LCALL   ??simI2c_stop?relay
   \   000003   7F05         MOV     R7,#0x5
   \   000005   02....       LJMP    ?BANKED_LEAVE_XDATA

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine7:
   \   000000   EE           MOV     A,R6
   \   000001   25..         ADD     A,?V0 + 2
   \   000003   F582         MOV     DPL,A
   \   000005   EF           MOV     A,R7
   \   000006   35..         ADDC    A,?V0 + 3
   \   000008   F583         MOV     DPH,A
   \   00000A   22           RET

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine6:
   \   000000   F9           MOV     R1,A
   \   000001   12....       LCALL   ??simI2c_write_byte?relay
   \   000004   75..00       MOV     ?V0 + 2,#0x0
   \   000007   75..00       MOV     ?V0 + 3,#0x0
   \   00000A   22           RET

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine5:
   \   000000   E5..         MOV     A,?V0 + 2
   \   000002   2401         ADD     A,#0x1
   \   000004   F5..         MOV     ?V0 + 2,A
   \   000006   E5..         MOV     A,?V0 + 3
   \   000008   3400         ADDC    A,#0x0
   \   00000A   F5..         MOV     ?V0 + 3,A
   \   00000C   22           RET

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine4:
   \   000000   C3           CLR     C
   \   000001   E5..         MOV     A,?V0 + 2
   \   000003   95..         SUBB    A,?V0 + 0
   \   000005   E5..         MOV     A,?V0 + 3
   \   000007   95..         SUBB    A,?V0 + 1
   \   000009   A2D2         MOV     C,0xD0 /* PSW */.2
   \   00000B   65D0         XRL     A,PSW
   \   00000D   33           RLC     A
   \   00000E   22           RET
    228          
    229            
    230          /*  
    231          I2C写操作  
    232          addr：目标设备地址  
    233          buf：写缓冲区  
    234          len：写入字节的长度  
    235          */  

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    236          void simI2c_write (unsigned char addr, unsigned char* buf, int len)  
   \                     simI2c_write:
    237          {  
   \   000000   74F3         MOV     A,#-0xd
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 13
   \   000005                ; Auto size: 0
   \   000005   89..         MOV     ?V0 + 4,R1
   \   000007   EA           MOV     A,R2
   \   000008   FE           MOV     R6,A
   \   000009   EB           MOV     A,R3
   \   00000A   FF           MOV     R7,A
   \   00000B   8C..         MOV     ?V0 + 0,R4
   \   00000D   8D..         MOV     ?V0 + 1,R5
    238          	int i;  
    239          	unsigned char t;  
    240          	simI2c_start();                        //起始条件，开始数据通信  
   \   00000F                ; Setup parameters for call to function simI2c_start
   \   00000F   12....       LCALL   ??simI2c_start?relay
    241          
    242          	//发送地址和数据读写方向  
    243          	t = (addr << 1) | 0;                    //低位为0，表示写数据  
    244          	simI2c_write_byte(t);  
   \   000012                ; Setup parameters for call to function simI2c_write_byte
   \   000012   E5..         MOV     A,?V0 + 4
   \   000014   C3           CLR     C
   \   000015   33           RLC     A
   \   000016   12....       LCALL   ?Subroutine6 & 0xFFFF
    245          
    246          	//写入数据  
    247          	for (i=0; i<len; i++)  
   \                     ??CrossCallReturnLabel_7:
   \   000019   800B         SJMP    ??CrossCallReturnLabel_5
    248          		simI2c_write_byte(buf[i]);  
   \                     ??simI2c_write_0:
   \   00001B                ; Setup parameters for call to function simI2c_write_byte
   \   00001B   12....       LCALL   ?Subroutine7 & 0xFFFF
   \                     ??CrossCallReturnLabel_9:
   \   00001E   E0           MOVX    A,@DPTR
   \   00001F   F9           MOV     R1,A
   \   000020   12....       LCALL   ??simI2c_write_byte?relay
   \   000023   12....       LCALL   ?Subroutine5 & 0xFFFF
   \                     ??CrossCallReturnLabel_5:
   \   000026   12....       LCALL   ?Subroutine4 & 0xFFFF
   \                     ??CrossCallReturnLabel_3:
   \   000029   40F0         JC      ??simI2c_write_0
    249          	simI2c_stop();                     //终止条件，结束数据通信  
   \   00002B                ; Setup parameters for call to function simI2c_stop
   \   00002B   80..         SJMP    ?Subroutine2
    250          } 

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??udelay?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    udelay

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??set_scl_output?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    set_scl_output

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??set_sda_output?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    set_sda_output

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??set_scl_input?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    set_scl_input

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??set_sda_input?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    set_sda_input

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??simI2c_start?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    simI2c_start

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??simI2c_stop?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    simI2c_stop

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??simI2c_read_ack?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    simI2c_read_ack

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??simI2c_send_ack?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    simI2c_send_ack

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??simI2c_write_byte?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    simI2c_write_byte

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??simI2c_read_byte?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    simI2c_read_byte

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??simI2c_read?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    simI2c_read

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??simI2c_write?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    simI2c_write

   \                                 In  segment XDATA_ROM_C, align 1
   \                     `?<Constant "nak?!?">`:
   \   000000   6E616B3F     DB "nak?!?"
   \            213F00  
    251          

   Maximum stack usage in bytes:

     Function               ISTACK PSTACK XSTACK
     --------               ------ ------ ------
     set_scl_input              0      0      0
     set_scl_output             0      0      0
     set_sda_input              0      0      9
     set_sda_output             0      0     12
     simI2c_read                1      0     13
       -> simI2c_start          0      0     26
       -> simI2c_write_byte     0      0     26
       -> simI2c_read_byte      0      0     26
       -> simI2c_stop           0      0     26
     simI2c_read_ack            2      0     12
       -> set_sda_input         4      0      0
       -> udelay                4      0      0
     simI2c_read_byte           0      0     22
       -> set_sda_input         0      0     18
       -> udelay                0      0     18
       -> udelay                0      0     18
       -> simI2c_send_ack       0      0     18
     simI2c_send_ack            2      0      9
       -> set_sda_output        4      0      0
       -> udelay                4      0      0
       -> udelay                4      0      0
     simI2c_start               2      0     13
       -> set_scl_output        4      0      0
       -> set_sda_output        4      0      0
       -> udelay                4      0      0
       -> udelay                4      0      0
     simI2c_stop                2      0     13
       -> set_sda_output        4      0      0
       -> udelay                4      0      0
     simI2c_write               0      0     13
       -> simI2c_start          0      0     26
       -> simI2c_write_byte     0      0     26
       -> simI2c_write_byte     0      0     26
       -> simI2c_stop           0      0     26
     simI2c_write_byte          0      0     25
       -> set_sda_output        0      0     24
       -> udelay                0      0     24
       -> udelay                0      0     24
       -> udelay                0      0     24
       -> udelay                0      0     24
       -> simI2c_read_ack       0      0     24
       -> HalUARTWrite          0      0     24
     udelay                     0      0     21
       -> Onboard_wait          0      0     18


   Segment part sizes:

     Function/Label            Bytes
     --------------            -----
     _A_P1                        1
     P1SEL                        1
     P1INP                        1
     P1DIR                        1
     udelay                      43
     ?Subroutine0                 5
     set_scl_output               9
     set_sda_output               9
     set_scl_input               12
     set_sda_input               12
     simI2c_start                36
     ?Subroutine1                 7
     simI2c_stop                 22
     simI2c_read_ack             25
     simI2c_send_ack             18
     ?Subroutine3                15
     simI2c_write_byte          105
     simI2c_read_byte            51
     simI2c_read                 45
     ?Subroutine2                 8
     ?Subroutine7                11
     ?Subroutine6                11
     ?Subroutine5                13
     ?Subroutine4                15
     simI2c_write                45
     ??udelay?relay               6
     ??set_scl_output?relay       6
     ??set_sda_output?relay       6
     ??set_scl_input?relay        6
     ??set_sda_input?relay        6
     ??simI2c_start?relay         6
     ??simI2c_stop?relay          6
     ??simI2c_read_ack?relay      6
     ??simI2c_send_ack?relay      6
     ??simI2c_write_byte?relay    6
     ??simI2c_read_byte?relay     6
     ??simI2c_read?relay          6
     ??simI2c_write?relay         6
     ?<Constant "nak?!?">         7

 
 517 bytes in segment BANKED_CODE
  78 bytes in segment BANK_RELAYS
   4 bytes in segment SFR_AN
   7 bytes in segment XDATA_ROM_C
 
 595 bytes of CODE  memory
   7 bytes of CONST memory
   0 bytes of DATA  memory (+ 4 bytes shared)

Errors: none
Warnings: none
